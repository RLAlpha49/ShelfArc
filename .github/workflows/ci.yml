name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Cache Bun deps & node_modules
        uses: actions/cache@v5
        with:
          path: |
            node_modules
            ~/.bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check formatting
        run: bunx prettier --check .

      - name: Run lint
        run: bun lint

      - name: Run type check
        run: bun run typecheck

      - name: Build project
        run: bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Upload Next build
        uses: actions/upload-artifact@v6
        with:
          name: next-build
          path: .next
          include-hidden-files: true

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: [build]
    env:
      CHROME_PATH: /usr/bin/google-chrome

    steps:
      - name: Cache Bun deps & node_modules
        uses: actions/cache@v5
        with:
          path: |
            node_modules
            ~/.bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Cache Puppeteer browser
        uses: actions/cache@v5
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-puppeteer-

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check Lighthouse secrets
        id: check-lhci-secrets
        run: |
          if [ -n "${NEXT_PUBLIC_SUPABASE_URL:-}" ] && [ -n "${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY:-}" ]; then
            echo "has_secrets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_secrets=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}

      - name: Warn — Lighthouse skipped (secrets missing)
        if: ${{ steps.check-lhci-secrets.outputs.has_secrets == 'false' }}
        run: |
          echo "::warning title=Lighthouse CI skipped::NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY are not configured as repository secrets."
          echo "::warning::Performance and accessibility regressions cannot be detected without these secrets. Add them in Settings → Secrets and variables → Actions."
          echo "--- Lighthouse CI: SKIPPED (required secrets missing) ---"

      - name: Install dependencies
        if: ${{ steps.check-lhci-secrets.outputs.has_secrets == 'true' }}
        run: bun install

      - name: Download Next build
        if: ${{ steps.check-lhci-secrets.outputs.has_secrets == 'true' }}
        uses: actions/download-artifact@v6
        with:
          name: next-build
          path: .next

      - name: Run Lighthouse CI
        if: ${{ steps.check-lhci-secrets.outputs.has_secrets == 'true' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
          LHCI_TEST_EMAIL: ${{ secrets.LHCI_TEST_EMAIL }}
          LHCI_TEST_PASSWORD: ${{ secrets.LHCI_TEST_PASSWORD }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: bunx lhci autorun

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Cache Bun deps & node_modules
        uses: actions/cache@v5
        with:
          path: |
            node_modules
            ~/.bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run unit tests with coverage (sequential to avoid flaky concurrent module mocks)
        run: bun test --coverage --max-concurrency=1

      - name: Dead-code / unused-export scan
        run: bunx knip

  # e2e-chromium:
  #   name: E2E Chromium
  #   runs-on: ubuntu-latest
  #   needs: [build, unit-tests]

  #   steps:
  #     - name: Cache Bun deps & node_modules
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           node_modules
  #           ~/.bun
  #         key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-bun-

  #     - name: Cache Playwright browsers
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cache/ms-playwright
  #         key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-playwright-

  #     - name: Cache Next build cache
  #       uses: actions/cache@v4
  #       with:
  #         path: .next/cache
  #         key: ${{ runner.os }}-next-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-next-

  #     - name: Checkout code
  #       uses: actions/checkout@v6

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Install dependencies
  #       run: bun install

  #     - name: Install Playwright browsers and system dependencies
  #       run: bunx playwright install --with-deps

  #     - name: Run Playwright E2E tests (Chromium)
  #       id: playwright_chromium
  #       run: bun run test:e2e -- --project=chromium

  #     - name: Upload Playwright artifacts (Chromium)
  #       if: ${{ always() && steps.playwright_chromium.outcome == 'failure' }}
  #       uses: actions/upload-artifact@v5
  #       with:
  #         name: playwright-report-chromium
  #         path: |
  #           tests/e2e/playwright-report
  #           tests/e2e/test-results

  # e2e-mobile:
  #   name: E2E Mobile Chrome
  #   runs-on: ubuntu-latest
  #   needs: [build, unit-tests]

  #   steps:
  #     - name: Cache Bun deps & node_modules
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           node_modules
  #           ~/.bun
  #         key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-bun-

  #     - name: Cache Playwright browsers
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cache/ms-playwright
  #         key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-playwright-

  #     - name: Cache Next build cache
  #       uses: actions/cache@v4
  #       with:
  #         path: .next/cache
  #         key: ${{ runner.os }}-next-${{ hashFiles('**/bun.lock') }}
  #         restore-keys: ${{ runner.os }}-next-

  #     - name: Checkout code
  #       uses: actions/checkout@v6

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Install dependencies
  #       run: bun install

  #     - name: Install Playwright browsers and system dependencies
  #       run: bunx playwright install --with-deps

  #     - name: Run Playwright E2E tests (Mobile Chrome)
  #       id: playwright_mobile
  #       run: bun run test:e2e -- --project=mobile-chrome

  #     - name: Upload Playwright artifacts (Mobile Chrome)
  #       if: ${{ always() && steps.playwright_mobile.outcome == 'failure' }}
  #       uses: actions/upload-artifact@v5
  #       with:
  #         name: playwright-report-mobile-chrome
  #         path: |
  #           tests/e2e/playwright-report
  #           tests/e2e/test-results
